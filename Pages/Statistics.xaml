<Page x:Class="DataGateWin.Pages.Statistics"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
      xmlns:oxy="http://oxyplot.org/wpf"
      Loaded="OnLoaded">

    <Page.Resources>
        <ControlTemplate x:Key="ChartTrackerTemplate">
            <oxy:TrackerControl
                Position="{Binding Position}"
                LineExtents="{Binding LineExtents}"
                LineStroke="{DynamicResource ControlStrokeColorDefaultBrush}"
                Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                FontFamily="Segoe UI"
                FontSize="12"
                CornerRadius="8"
                Distance="10"
                ShowPointer="True">

                <oxy:TrackerControl.Content>
                    <Border
                        Background="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=Background}"
                        BorderBrush="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=BorderBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="10">
                        <TextBlock
                            Text="{Binding Text}"
                            Foreground="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=Foreground}"
                            TextWrapping="Wrap" />
                    </Border>
                </oxy:TrackerControl.Content>
            </oxy:TrackerControl>
        </ControlTemplate>
    </Page.Resources>

    <ScrollViewer
        VerticalScrollBarVisibility="Auto"
        HorizontalScrollBarVisibility="Disabled">

        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="12"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="12"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="12"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <ui:TextBlock Grid.Row="0"
                          Text="Statistics"
                          FontTypography="Title"
                          FontSize="20"
                          Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                          FontWeight="SemiBold"/>

            <!-- Filters -->
            <ui:Card Grid.Row="2" Padding="12"
                     HorizontalContentAlignment="Stretch"
                     VerticalContentAlignment="Stretch">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="10"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="10"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="10"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Row 0: main filters -->
                    <WrapPanel Grid.Row="0" VerticalAlignment="Center">
                        <ui:TextBlock Text="From"
                                      Margin="0,0,8,0"
                                      VerticalAlignment="Center"
                                      Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>

                        <ui:CalendarDatePicker Width="170"
                                               Date="{Binding FromLocalDate, Mode=TwoWay}"
                                               Content="{Binding FromLocalDate, StringFormat={}{0:yyyy-MM-dd}}"
                                               Appearance="Secondary"/>

                        <ui:TextBlock Text="To"
                                      Margin="16,0,8,0"
                                      VerticalAlignment="Center"
                                      Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>

                        <ui:CalendarDatePicker Width="170"
                                               Date="{Binding ToLocalDate, Mode=TwoWay}"
                                               Content="{Binding ToLocalDate, StringFormat={}{0:yyyy-MM-dd}}"
                                               Appearance="Secondary"/>
                    </WrapPanel>

                    <!-- Row 2: grouping -->
                    <WrapPanel Grid.Row="2" VerticalAlignment="Center">
                        <ui:TextBlock Text="Grouping"
                                      Margin="0,0,8,0"
                                      VerticalAlignment="Center"
                                      Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>

                        <ui:DropDownButton Width="160"
                                           Content="{Binding GroupingText}"
                                           Appearance="Secondary">
                            <ui:DropDownButton.Flyout>
                                <ContextMenu>
                                    <MenuItem Header="Auto"   Command="{Binding SetGroupingCommand}" CommandParameter="Auto"/>
                                    <MenuItem Header="Hours"  Command="{Binding SetGroupingCommand}" CommandParameter="Hours"/>
                                    <MenuItem Header="Days"   Command="{Binding SetGroupingCommand}" CommandParameter="Days"/>
                                    <MenuItem Header="Months" Command="{Binding SetGroupingCommand}" CommandParameter="Months"/>
                                    <MenuItem Header="Years"  Command="{Binding SetGroupingCommand}" CommandParameter="Years"/>
                                </ContextMenu>
                            </ui:DropDownButton.Flyout>
                        </ui:DropDownButton>
                    </WrapPanel>

                    <!-- Row 4: quick range -->
                    <WrapPanel Grid.Row="4" VerticalAlignment="Center">
                        <ui:Button Content="7 days"
                                   Command="{Binding SetLastDaysCommand}"
                                   CommandParameter="7"
                                   Margin="0,0,8,0"
                                   Appearance="Secondary"/>

                        <ui:Button Content="30 days"
                                   Command="{Binding SetLastDaysCommand}"
                                   CommandParameter="30"
                                   Margin="0,0,8,0"
                                   Appearance="Secondary"/>

                        <ui:Button Content="90 days"
                                   Command="{Binding SetLastDaysCommand}"
                                   CommandParameter="90"
                                   Margin="0,0,16,0"
                                   Appearance="Secondary"/>
                    </WrapPanel>

                    <!-- Row 6: apply/reset -->
                    <DockPanel Grid.Row="6" LastChildFill="True">
                        <WrapPanel DockPanel.Dock="Left">
                            <ui:Button Content="Apply"
                                       Command="{Binding ApplyFiltersCommand}"
                                       Margin="0,0,8,0"/>

                            <ui:Button Content="Reset"
                                       Command="{Binding ResetFiltersCommand}"
                                       Appearance="Secondary"/>
                        </WrapPanel>

                        <ui:TextBlock Text="{Binding ErrorText}"
                                      Foreground="Tomato"
                                      VerticalAlignment="Center"
                                      Margin="16,0,0,0"/>
                    </DockPanel>
                </Grid>
            </ui:Card>

            <!-- Summary -->
            <ui:Card Grid.Row="4"
                     Padding="12"
                     HorizontalContentAlignment="Stretch"
                     VerticalContentAlignment="Stretch">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel>
                        <ui:TextBlock Text="Uploaded"
                                      FontTypography="BodyStrong"
                                      Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                        <ui:TextBlock Text="{Binding TotalUploadedText}"
                                      FontSize="24"
                                      FontWeight="SemiBold"
                                      Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                        <ui:TextBlock Text="{Binding PeriodText}"
                                      Foreground="{DynamicResource TextFillColorTertiaryBrush}"/>
                    </StackPanel>

                    <ui:ProgressRing Grid.Column="1"
                                     Width="28"
                                     Height="28"
                                     IsIndeterminate="True"
                                     Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                </Grid>
            </ui:Card>

            <!-- Chart -->
            <ui:Card Grid.Row="6"
                     Padding="12">
                <Grid MinHeight="220">
                    <oxy:PlotView x:Name="Chart"
                                  Model="{Binding PlotModel}"
                                  DefaultTrackerTemplate="{StaticResource ChartTrackerTemplate}"/>
                </Grid>
            </ui:Card>

        </Grid>
    </ScrollViewer>
</Page>
